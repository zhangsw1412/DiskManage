<?php

class ArticleAction extends CommonAction
{
	//文章列表
	public function index()
	{
		$this->article=D('ArticleRelation')->getArticles();
		$this->display();
	}

	//添加文章
	public function article()
	{
		//文章所属分类
		$cate=M('cate')->order('sort')->select();
		import('Class.Category',APP_PATH);
		$this->cate=Category::unlimited4Level($cate);

		//文章属性
		$this->attr=M('attr')->select();

		$this->display();
	}

	//删除到回收站或从回收站还原
	public function toTrash()
	{
		$msg=I('type')?'删除':'还原';
		$update=array(
			'id'=>I('id'),
			'del'=>I('type')
			);
		if(M('article')->save($update))
		{
			$this->success($msg.'成功',U(GROUP_NAME.'/article/index'));
		}
		else
		{
			$this->error($msg.'失败');
		}
	}

	//回收站
	public function trash()
	{
		$this->article=D('ArticleRelation')->getArticles(1);
		$this->display('index');
	}

	//彻底删除文章
	public function delete()
	{
		$id=I('id');
		if(M('article')->delete($id))
		{
			M('article_attr')->where(array('bid'=>$id))->delete();
			$this->success('删除成功',U(GROUP_NAME.'/article/trash'));
		}
		else
		{
			$this->error('删除失败');
		}
	}

	//添加文章表单处理
	public function addArticle()
	{
		$data=array(
			'title'=>I('post.title'),
			'content'=>I('post.content'),
			'summary'=>I('post.summary'),
			'time'=>time(),
			'click'=>(int)I('post.click'),
			'cid'=>(int)I('post.cid')
			);
		if($bid=M('article')->add($data))
		{
			if(isset($_POST['aid']))
			{
				$sql='insert into '.C('DB_PREFIX').'article_attr (bid,aid) values ';
				foreach($_POST['aid'] as $v)
				{
					$sql .= '('.$bid.','.$v.'),';
				}
				$sql=rtrim($sql,',');
				M('article_attr')->query($sql);
			}
			$this->success('添加成功',U(GROUP_NAME.'/article/index'));
		}
		else
		{
			$this->error('添加失败');
		}
	}

	//编辑器图片上传处理
	public function upload()
	{
		import('ORG.Net.UploadFile');
		$upload=new UploadFile();
		$upload->autoSub=true;
		$upload->subType='date';

		if($upload->upload('./Uploads/'))
		{
			$info=$upload->getUploadFileInfo();
			import('Class.Image',APP_PATH);
			Image::water('./Uploads/'.$info[0]['savename']);
			echo json_encode(array(
				'url'=>$info[0]['savename'],
				'title'=>htmlspecialchars($_POST['pictitle'],ENT_QUOTES),
				'original'=>$info[0]['name'],
				'state'=>'SUCCESS'
				));
		}
		else
		{
			echo json_encode(array(
				'state'=>$upload->getErrorMsg()
				));
		}
	}
}

?>